#include "SDL3/SDL_keyboard.h"
#include "SDL3/SDL_keycode.h"
#include "SDL3/SDL_pixels.h"
#include "SDL3/SDL_surface.h"
#include <SDL3/SDL_events.h>
#include <SDL3/SDL_init.h>
#include <SDL3/SDL_log.h>
#include <SDL3/SDL_render.h>
#include <SDL3/SDL_video.h>
#include <SDL3_ttf/SDL_ttf.h>

#include <cassert>
#include <cmath>
#include <cstddef>
#include <cstdio>
#include <cstring>
#include <filesystem>
#include <fstream>
#include <iostream>

enum Mode { NORMAL, INSERT };

int main(int argc, char *argv[]) {
    bool running = true;
    Mode activeMode = NORMAL;
    SDL_Window *window;
    SDL_Renderer *renderer;
    SDL_Surface *surface; 
    SDL_Texture *texture;

    static TTF_Font *font = NULL;
    TTF_Init();
    SDL_Init(SDL_INIT_VIDEO);

    SDL_CreateWindowAndRenderer("Text Editor", 1280, 760, SDL_WINDOW_TRANSPARENT,
            &window, &renderer);
    TTF_TextEngine *text_engine = TTF_CreateRendererTextEngine(renderer);
    font = TTF_OpenFont(
            "/usr/share/fonts/JetBrainsMono/JetBrainsMonoNerdFont-Regular.ttf", 25);
    if (font == NULL) {
        SDL_Log("Error loading font: %s", SDL_GetError());
    }
    std::string textString{};
    TTF_Text *text = TTF_CreateText(text_engine, font, textString.c_str(), 0);

    std::string filepath = "";
    if(argc < 2){
        // SDL_Log("No file was passed in!");
        std::cout << "No file was passed in!\n";
        filepath = "file.txt";
    }else{
        std::cout << "argc: " << argc << ", argv: " << argv[1] << "\n";
        filepath = argv[1];
        if(std::filesystem::is_regular_file(filepath)){
            std::cout << filepath << " is a regular file!\n";
        }
    }
    assert(std::filesystem::is_regular_file(filepath));

    std::ifstream file(filepath);
    if(!file.is_open()){
        std::cout << "Failed to open " << filepath << "\n";
        return 0;
    }

    //write the file to the piece table here 

    int windowWidth, windowHeight;
    int textWidth, textHeight;


    SDL_GetWindowSize(window, &windowWidth, &windowHeight);
    SDL_Color col = SDL_Color(255, 255, 255);
    char insertText[1024] = {0};
    surface = TTF_RenderText_Solid_Wrapped(font, "Testing", 0, SDL_Color{255, 255, 255}, windowWidth);
    texture = SDL_CreateTextureFromSurface(renderer, surface);
    while (running) {
        SDL_Event event;
        while (SDL_PollEvent(&event)) {
            switch (event.type) {
                case SDL_EVENT_TEXT_INPUT:
                    strncpy(insertText, event.text.text, sizeof(insertText));

                    //TODO: add this to the piece table
                    TTF_AppendTextString(text, insertText, strnlen(insertText, sizeof(insertText)));
                    break;
                case SDL_EVENT_KEY_DOWN:
                    SDL_Keycode keycode = event.key.key;
                    if (keycode == SDLK_RETURN && activeMode == INSERT) {
                        // SDL_strlcat(insertText, event.text.text, sizeof(insertText));
                        strncpy(insertText, "\n", sizeof(insertText));

                        //TODO: add this to the piece table
                        TTF_AppendTextString(text, insertText, strnlen(insertText, sizeof(insertText)));
                        // textString += "\n";
                    }
                    if (keycode == SDLK_ESCAPE || (keycode == SDLK_Q && activeMode != INSERT)) {
                        SDL_StopTextInput(window);
                        activeMode = NORMAL;
                        running = false;
                    } else if (keycode == SDLK_I) {
                        SDL_StartTextInput(window);
                        activeMode = INSERT;
                    } else if (keycode == SDLK_C && event.key.mod == SDL_KMOD_LCTRL){
                        SDL_StopTextInput(window);
                        activeMode = NORMAL;
                    }
                    // process mode changes and stuff here
                    break;
            }
        }

        // If this isn't here, the program will leak memory and brick ur computer

        SDL_DestroyTexture(texture);
        TTF_GetTextSize(text, &textWidth, &textHeight);

        surface = TTF_RenderText_Solid_Wrapped(font, text->text, 0, col, windowWidth);
        if(surface != NULL){
            SDL_FRect rect{0, 0, (float)std::min(textWidth, windowWidth), (float)surface->h};
            texture = SDL_CreateTextureFromSurface(renderer, surface);
            SDL_DestroySurface(surface);
            SDL_RenderTexture(renderer, texture, NULL, &rect);
        }else {
            std::cout << "Surface is null!\n"
        }

        SDL_RenderClear(renderer);
        // TTF_DrawRendererText(text, 0, 0);
        SDL_RenderPresent(renderer);
    }
    SDL_DestroyRenderer(renderer);
    TTF_DestroyText(text);
    SDL_DestroyTexture(texture);
    TTF_DestroyRendererTextEngine(text_engine);
    SDL_DestroyWindow(window);
    // delete insertText;

    return 0;
}
